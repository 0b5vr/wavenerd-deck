<!DOCTYPE html>

<body>
  <textarea cols="100" rows="40" id="textarea">
  </textarea><br />
  BPM: <input id="inputBpm" type="number" value="190" /><br />
  <button id="buttonCompile">Compile</button>
  <button id="buttonApplyCue" disabled>Apply Cue</button><br />
  <span id="spanStatus">Awaiting cue</span>
</body>

<script src="../dist/wavenerd-deck.js"></script>
<script src="https://unpkg.com/@fms-cat/glcat-ts@0.10.0/dist/glcat.js"></script>
<script>
( async() => {
  const canvas = document.createElement( 'canvas' );
  const gl = canvas.getContext( 'webgl' );
  const glCat = new GLCat( gl );

  const audio = new AudioContext();

  console.log( WAVENERD_DECK );
  const waveNerdDeck = new WAVENERD_DECK.WaveNerdDeck( { glCat, audio } );
  waveNerdDeck.node.connect( audio.destination );
  waveNerdDeck.bpm = 190;

  await fetch( './samples/amen.ogg' )
  .then( ( res ) => res.arrayBuffer() )
  .then( ( buffer ) => waveNerdDeck.loadSample( 'sampleAmen', buffer ) );

  await fetch( './samples/noise.wav' )
  .then( ( res ) => res.arrayBuffer() )
  .then( ( buffer ) => waveNerdDeck.loadSample( 'sampleNoise', buffer ) );

  await fetch( './samples/crash.ogg' )
  .then( ( res ) => res.arrayBuffer() )
  .then( ( buffer ) => waveNerdDeck.loadSample( 'sampleCrash', buffer ) );

  await fetch( './samples/909oh.ogg' )
  .then( ( res ) => res.arrayBuffer() )
  .then( ( buffer ) => waveNerdDeck.loadSample( 'sample909OH', buffer ) );

  const frag = await fetch( './sine.frag' )
    .then( ( res ) => res.text() );

  textarea.value = frag;

  waveNerdDeck.compile( frag );

  // == wavenerd deck event listeners ==============================================================
  waveNerdDeck.on( 'changeCueStatus', ( { cueStatus } ) => {
    buttonApplyCue.disabled = cueStatus !== 'ready';

    spanStatus.innerText = (
      cueStatus === 'none' ? 'Awaiting cue' :
      cueStatus === 'ready' ? 'Ready' :
      'Applying...'
    )
  } );

  // == ui listeners ===============================================================================
  inputBpm.addEventListener( 'change', () => {
    waveNerdDeck.bpm = inputBpm.value;
  } );

  buttonCompile.addEventListener( 'click', () => {
    waveNerdDeck.compile( textarea.value );
  } );

  buttonApplyCue.addEventListener( 'click', () => {
    waveNerdDeck.applyCue();
  } );
} )();
</script>
