/*! @fms-cat/wavenerd-deck v0.3.1 - (c) FMS-Cat, MIT License */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WAVENERD_DECK=t():e.WAVENERD_DECK=t()}(this,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(a,i){function o(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,u)}s((n=n.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var r,n,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],n=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.WavenerdDeck=void 0;var o=r(1),u=r(6),s=r(2),_=r(3),f=function(){function e(e){var t=this,r=e.glCat,n=e.audio,a=e.hostDeck,i=e.bufferSize,u=e.chunkSize,s=e.bpm,_=e.timeErrorThreshold;this.__cueStatus="none",this.__chunkHead=0,this.__time=0,this.__program=null,this.__programCue=null,this.__samples=new Map,this.timeErrorThreshold=null!=_?_:.01,this.__bufferSize=null!=i?i:2048,this.__chunkSize=null!=u?u:64,a&&(this.hostDeck=a),this.__beatManager=new o.BeatManager,this.__beatManager.bpm=null!=s?s:140,this.__beatManager.on("changeBPM",(function(e){var r=e.bpm;t.__chunkHead=0,t.__emit("changeBPM",{bpm:r})})),this.__glCat=r;var f=r.gl;r.getExtension("EXT_color_buffer_float"),this.__bufferQuad=r.createBuffer(),this.__bufferQuad.setVertexbuffer(new Float32Array([-1,-1,1,-1,-1,1,1,1])),this.__renderbuffer=r.createRenderbuffer(),this.__renderbuffer.renderbufferStorage(this.__bufferSize/2,this.__chunkSize,{format:f.RGBA32F}),this.__framebuffer=r.createFramebuffer(),this.__framebuffer.attachRenderbuffer(this.__renderbuffer,{attachment:f.COLOR_ATTACHMENT0}),this.__pixelBuffer=new Float32Array(2*this.__bufferSize*this.__chunkSize),this.__audio=n,this.__node=n.createScriptProcessor(this.__bufferSize,2,2),this.__node.onaudioprocess=function(e){return t.__handleProcess(e)}}return Object.defineProperty(e.prototype,"cueStatus",{get:function(){return this.__cueStatus},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bufferSize",{get:function(){return this.__bufferSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"chunkSize",{get:function(){return this.__chunkSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bpm",{get:function(){return this.beatManager.bpm},set:function(e){this.beatManager.bpm=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"time",{get:function(){return this.hostDeck?this.hostDeck.time:this.__time},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"glCat",{get:function(){return this.__glCat},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastError",{get:function(){return this.__lastError},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audio",{get:function(){return this.__audio},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"node",{get:function(){return this.__node},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sampleRate",{get:function(){return this.__audio.sampleRate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beatManager",{get:function(){var e,t=null===(e=this.hostDeck)||void 0===e?void 0:e.beatManager;return t||this.__beatManager},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"samples",{get:function(){return this.hostDeck?this.hostDeck.samples:this.__samples},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){this.__setCueStatus("none"),this.__bufferQuad.dispose(),this.__program&&this.__program.program.dispose(!0),this.__programCue&&this.__programCue.program.dispose(!0)},e.prototype.compile=function(e){return n(this,void 0,Promise,(function(){var t,r,n,o,s,_,f,l=this;return a(this,(function(a){switch(a.label){case 0:return this.__setCueStatus("compiling"),[4,this.__glCat.lazyProgramAsync("#version 300 es\nin vec2 p;\nvoid main() {\n  gl_Position = vec4( p, 0.0, 1.0 );\n}\n",u.shaderchunkPre+e+u.shaderchunkPost).catch((function(e){var t=l.__processErrorMessage(e);throw l.__lastError=t,l.__programCue=null,l.__setCueStatus("none"),l.__emit("error",{error:t}),new Error(null!=t?t:void 0)}))];case 1:t=a.sent(),r=new Set;try{for(n=i(this.samples.keys()),o=n.next();!o.done;o=n.next())s=o.value,-1!==e.search("sample_"+s)&&r.add(s)}catch(e){_={error:e}}finally{try{o&&!o.done&&(f=n.return)&&f.call(n)}finally{if(_)throw _.error}}return this.__programCue={program:t,code:e,requiredSamples:r},this.__setCueStatus("ready"),this.__emit("error",{error:null}),this.__lastError=null,[2]}}))}))},e.prototype.applyCue=function(){"ready"===this.__cueStatus&&this.__setCueStatus("applying")},e.prototype.loadSample=function(e,t){return n(this,void 0,Promise,(function(){var r=this;return a(this,(function(n){return this.__audio.decodeAudioData(t).then((function(t){for(var n=t.sampleRate,a=t.duration,i=t.length,o=Math.ceil(i/2048),u=new Float32Array(2048*o*4),s=t.numberOfChannels,_=t.getChannelData(0),f=t.getChannelData(1===s?0:1),l=0;l<i;l++)u[4*l+0]=_[l],u[4*l+1]=f[l];var c=r.__glCat.gl,p=r.__glCat.createTexture();p.setTextureFromArray(2048,o,u,{internalformat:c.RGBA32F,format:c.RGBA,type:c.FLOAT}),p.textureFilter(c.NEAREST),r.__samples.set(e,{name:e,texture:p,sampleRate:n,duration:a}),r.__program&&r.__program.code.search("sample_"+e)&&r.__program.requiredSamples.add(e),r.__programCue&&r.__programCue.code.search("sample_"+e)&&r.__programCue.requiredSamples.add(e),r.__emit("loadSample",{name:e,duration:a,sampleRate:n})})),[2]}))}))},e.prototype.deleteSample=function(e){this.__samples.has(e)&&(this.__samples.delete(e),this.__emit("deleteSample",{name:e}))},e.prototype.__handleProcess=function(e){var t=this.time;this.hostDeck||(t+=this.__bufferSize/this.__audio.sampleRate,this.timeErrorThreshold<Math.abs(t-e.playbackTime)&&(t=e.playbackTime)),this.__time=t;var r=this.beatManager.update(t),n=r.bpm,a=r.bar,i=o.BeatManager.CalcBarSeconds(n),u=e.outputBuffer.getChannelData(0),s=e.outputBuffer.getChannelData(1),_=this.sampleRate,f=this.__bufferSize,l="applying"===this.__cueStatus?Math.min(f,Math.floor((i-a)*_)):f;0===this.__chunkHead&&this.__prepareBuffer(r);for(var c=0;c<l;c++){var p=this.__chunkHead*this.__bufferSize*2;u[c]=this.__pixelBuffer[p+2*c+0],s[c]=this.__pixelBuffer[p+2*c+1]}if(l!==f){if(this.__setCueStatus("none"),this.__programCue){var h=this.__program;this.__program=this.__programCue,h&&h.program.dispose(!0),this.__programCue=null,this.__prepareBuffer(r)}this.__chunkHead=0;for(c=l;c<f;c++)u[c]=this.__pixelBuffer[2*c+0],s[c]=this.__pixelBuffer[2*c+1]}this.__chunkHead=(this.__chunkHead+1)%this.__chunkSize,this.__emit("process")},e.prototype.__prepareBuffer=function(e){var t=this,r=e.time,n=e.beat,a=e.bar,i=e.sixteenBar,u=e.bpm,s=o.BeatManager.CalcBeatSeconds(u),_=o.BeatManager.CalcBarSeconds(u),f=o.BeatManager.CalcSixteenBarSeconds(u),l=this.sampleRate,c=this.__bufferSize,p=this.__chunkSize,h=this.__glCat.gl;this.__program&&(this.samples.forEach((function(e){t.__program.program.uniformTexture("sample_"+e.name,e.texture),t.__program.program.uniform4f("sample_"+e.name+"_meta",e.texture.width,e.texture.height,e.sampleRate,e.duration)})),this.__program.program.attribute("p",this.__bufferQuad,2),this.__program.program.uniform1f("bpm",this.bpm),this.__program.program.uniform1f("_deltaSample",1/l),this.__program.program.uniform1f("_deltaChunk",this.__bufferSize/l),this.__program.program.uniform4f("timeLength",s,_,f,1e16),this.__program.program.uniform4f("_timeHead",n,a,i,r),this.__glCat.useProgram(this.__program.program,(function(){t.__glCat.bindFramebuffer(t.__framebuffer,(function(){h.viewport(0,0,t.__bufferSize/2,t.__chunkSize),h.blendFunc(t.__glCat.gl.ONE,t.__glCat.gl.ZERO),h.drawArrays(h.TRIANGLE_STRIP,0,4)}))})),h.flush(),this.__glCat.bindFramebuffer(this.__framebuffer,(function(){h.readBuffer(t.__glCat.gl.COLOR_ATTACHMENT0),h.readPixels(0,0,c/2,p,t.__glCat.gl.RGBA,t.__glCat.gl.FLOAT,t.__pixelBuffer)})))},e.prototype.__setCueStatus=function(e){this.__cueStatus=e,this.__emit("changeCueStatus",{cueStatus:e})},e.prototype.__processErrorMessage=function(e){var t,r=null!==(t=null==e?void 0:e.message)&&void 0!==t?t:e;return r?r.replace(/ERROR: (\d+):(\d+)/g,(function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var n=parseInt(t[1])-u.shaderchunkPreLines+1;return"ERROR: "+t[0]+":"+n})):null},e}();t.WavenerdDeck=f,_.applyMixins(f,[s.EventEmittable])},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BeatManager=void 0;var n=r(2),a=r(3),i=r(5),o=function(){function e(){this.__bpm=140,this.__time=0,this.__sixteenBar=0}return Object.defineProperty(e.prototype,"bpm",{get:function(){return this.__bpm},set:function(e){var t=this.__bpm;this.__bpm=Math.max(0,e),this.__sixteenBar=this.__sixteenBar*t/this.__bpm,this.__emit("changeBPM",{bpm:this.__bpm})},enumerable:!1,configurable:!0}),e.CalcBeatSeconds=function(e){return 60/e},e.CalcBarSeconds=function(e){return 240/e},e.CalcSixteenBarSeconds=function(e){return 3840/e},e.prototype.reset=function(){this.__time=0,this.__sixteenBar=0},e.prototype.update=function(t){var r=e.CalcBeatSeconds(this.__bpm),n=e.CalcBarSeconds(this.__bpm),a=e.CalcSixteenBarSeconds(this.__bpm),o=t-this.__time;this.__sixteenBar=i.mod(this.__sixteenBar+o,a);var u=this.__sixteenBar,s=i.mod(u,n),_=i.mod(s,r);this.__time=t;var f={time:t,deltaTime:o,bpm:this.__bpm,beat:_,bar:s,sixteenBar:u};return this.__emit("update",f),f},e}();t.BeatManager=o,a.applyMixins(o,[n.EventEmittable])},function(e,t,r){"use strict";var n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o};Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmittable=void 0;var a=function(){function e(){}return e.prototype.on=function(e,t){this.__eventListeners=this.__eventListeners||new Map;var r=this.__eventListeners.get(e);return r||(r=[],this.__eventListeners.set(e,r)),r.push(t),t},e.prototype.off=function(e,t){this.__eventListeners=this.__eventListeners||new Map;var r=this.__eventListeners.get(e);r||(r=[],this.__eventListeners.set(e,r));var n=r.indexOf(t);-1!==n&&r.splice(n,1)},e.prototype.__emit=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var a=n(t,2),i=a[0],o=a[1];this.__eventListeners=this.__eventListeners||new Map,null===(e=this.__eventListeners.get(i))||void 0===e||e.forEach((function(e){return e(o)}))},e}();t.EventEmittable=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.applyMixins=void 0,t.applyMixins=function(e,t){t.forEach((function(t){Object.getOwnPropertyNames(t.prototype).forEach((function(r){Object.defineProperty(e.prototype,r,Object.getOwnPropertyDescriptor(t.prototype,r))}))}))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);Object.defineProperty(t,"WavenerdDeck",{enumerable:!0,get:function(){return n.WavenerdDeck}});var a=r(1);Object.defineProperty(t,"BeatManager",{enumerable:!0,get:function(){return a.BeatManager}});var i=r(0);t.default=i.WavenerdDeck},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mod=void 0,t.mod=function(e,t){return e-Math.floor(e/t)*t}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shaderchunkPost=t.shaderchunkPreLines=t.shaderchunkPre=void 0,t.shaderchunkPre="#version 300 es\n\nprecision highp float;\n\n#define _PI 3.14159265359\n\nuniform float bpm;\nuniform vec4 timeLength;\nuniform float sampleRate;\nuniform float _deltaSample;\nuniform float _deltaChunk;\nuniform vec4 _timeHead;\n\nout vec4 fragColor;\n\nvec2 sampleNearest( sampler2D s, vec4 meta, float time ) {\n  if ( meta.w < time ) { return vec2( 0.0 ); }\n  float x = time / meta.x * meta.z;\n  vec2 uv = fract( vec2(\n    x,\n    floor( x ) / meta.y\n  ) ) + 0.5 / meta.xy;\n  return texture( s, uv ).xy;\n}\n\n// I have 0% confidence that the algorithm is perfect\nvec2 sampleSinc( sampler2D s, vec4 meta, float time ) {\n  if ( meta.w < time ) { return vec2( 0.0 ); }\n  vec2 sum = vec2( 0.0 );\n  float def = 0.5 - fract( time * meta.z );\n  for ( int i = -5; i <= 5; i ++ ) {\n    float x = floor( time * meta.z + float( i ) ) / meta.x;\n    float deft = def + float( i );\n    vec2 uv = fract( vec2(\n      x,\n      floor( x ) / meta.y\n    ) ) + 0.5 / meta.xy;\n    sum += texture( s, uv ).xy * min( sin( deft * _PI ) / deft / _PI, 1.0 );\n  }\n  return sum;\n}\n",t.shaderchunkPreLines=t.shaderchunkPre.split("\n").length,t.shaderchunkPost="void main() {\n  float off = floor( gl_FragCoord.x ) * 2.0;\n  vec4 head = _timeHead + _deltaChunk * floor( gl_FragCoord.y );\n  fragColor = vec4(\n    mainAudio( mod( head + ( off ) * _deltaSample, timeLength ) ),\n    mainAudio( mod( head + ( off + 1.0 ) * _deltaSample, timeLength ) )\n  );\n}"}])}));