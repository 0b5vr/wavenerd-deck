/*! @fms-cat/wavenerd-deck v0.4.0 - (c) FMS-Cat, MIT License */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WAVENERD_DECK=t():e.WAVENERD_DECK=t()}(this,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(a,i){function o(e){try{u(n.next(e))}catch(e){i(e)}}function s(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}u((n=n.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var r,n,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],n=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.WavenerdDeck=t.shaderFrag=void 0;var o=r(5),s=r(1),u=r(2),f=r(7),_=r(3),c=r(8);t.shaderFrag="#version 300 es\n\nvoid main() {\n  discard;\n}";var l=function(){function e(e){var t=this,r=e.glCat,n=e.audio,a=e.hostDeck,i=e.bufferLength,o=e.bpm;this.__cueStatus="none",this.__prevBufferSource=null,this.__program=null,this.__programCue=null,this.__programSwapTime=0,this.__params=new Map,this.__samples=new Map,this.__bufferLength=null!=i?i:4096,a&&(this.hostDeck=a),this.__beatManager=new s.BeatManager,this.__beatManager.bpm=null!=o?o:140,this.__beatManager.on("changeBPM",(function(e){var r=e.bpm;t.__emit("changeBPM",{bpm:r})})),this.__glCat=r;var u=r.gl,_=new Array(this.__bufferLength).fill(0).map((function(e,t){return t}));this.__bufferOff=r.createBuffer(),this.__bufferOff.setVertexbuffer(new Float32Array(_)),this.__bufferTransformFeedbacks=[r.createBuffer(),r.createBuffer()],this.__transformFeedback=r.createTransformFeedback(),this.__bufferTransformFeedbacks[0].setVertexbuffer(this.__bufferLength*Float32Array.BYTES_PER_ELEMENT,u.DYNAMIC_COPY),this.__bufferTransformFeedbacks[1].setVertexbuffer(this.__bufferLength*Float32Array.BYTES_PER_ELEMENT,u.DYNAMIC_COPY),this.__transformFeedback.bindBuffer(0,this.__bufferTransformFeedbacks[0]),this.__transformFeedback.bindBuffer(1,this.__bufferTransformFeedbacks[1]),this.__audio=n,this.__node=n.createGain(),this.__bufferPool=new f.Pool([n.createBuffer(2,this.__bufferLength,n.sampleRate),n.createBuffer(2,this.__bufferLength,n.sampleRate)])}return Object.defineProperty(e.prototype,"cueStatus",{get:function(){return this.__cueStatus},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bufferLength",{get:function(){return this.__bufferLength},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bpm",{get:function(){return this.beatManager.bpm},set:function(e){this.beatManager.bpm=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"glCat",{get:function(){return this.__glCat},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastError",{get:function(){return this.__lastError},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audio",{get:function(){return this.__audio},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"node",{get:function(){return this.__node},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sampleRate",{get:function(){return this.__audio.sampleRate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beatManager",{get:function(){var e,t=null===(e=this.hostDeck)||void 0===e?void 0:e.beatManager;return t||this.__beatManager},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"params",{get:function(){return this.__params},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"samples",{get:function(){return this.hostDeck?this.hostDeck.samples:this.__samples},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){this.__setCueStatus("none"),this.__transformFeedback.dispose(),this.__bufferTransformFeedbacks[0].dispose(),this.__bufferTransformFeedbacks[1].dispose(),this.__program&&this.__program.program.dispose(!0),this.__programCue&&this.__programCue.program.dispose(!0)},e.prototype.compile=function(e){return n(this,void 0,Promise,(function(){var r,n,s,u,f,_,c,l=this;return a(this,(function(a){switch(a.label){case 0:return this.__setCueStatus("compiling"),[4,this.__glCat.lazyProgramAsync(o.shaderchunkPre+e+o.shaderchunkPost,t.shaderFrag,{transformFeedbackVaryings:["outL","outR"]}).catch((function(e){var t=l.__processErrorMessage(e);throw l.__lastError=t,l.__programCue=null,l.__setCueStatus("none"),l.__emit("error",{error:t}),new Error(null!=t?t:void 0)}))];case 1:r=a.sent(),n=new Set;try{for(s=i(this.samples.keys()),u=s.next();!u.done;u=s.next())f=u.value,-1!==e.search("sample_"+f)&&n.add(f)}catch(e){_={error:e}}finally{try{u&&!u.done&&(c=s.return)&&c.call(s)}finally{if(_)throw _.error}}return this.__programCue={program:r,code:e,requiredSamples:n},this.__setCueStatus("ready"),this.__emit("error",{error:null}),this.__lastError=null,[2]}}))}))},e.prototype.applyCue=function(){"ready"===this.__cueStatus&&(this.__setCueStatus("applying"),this.__programSwapTime=this.beatManager.time-this.beatManager.bar+this.beatManager.barSeconds)},e.prototype.setParam=function(e,t,r){void 0===r&&(r=50);var n=this.__params.get(e);n?(n.target=t,n.factor=r):this.__params.set(e,{name:e,target:t,value:t,factor:r})},e.prototype.loadSample=function(e,t){return n(this,void 0,Promise,(function(){var r,n,i,o,s,u,f,_,c,l,p,h,m,d;return a(this,(function(a){switch(a.label){case 0:return[4,this.__audio.decodeAudioData(t)];case 1:for(r=a.sent(),n=r.sampleRate,i=r.duration,o=r.length,2048,s=Math.ceil(o/2048),u=s,f=new Float32Array(2048*u*4),_=r.numberOfChannels,c=r.getChannelData(0),l=r.getChannelData(1===_?0:1),p=0;p<o;p++)f[4*p+0]=c[p],f[4*p+1]=l[p];return h=this.__glCat,m=h.gl,(d=this.__glCat.createTexture()).setTextureFromArray(2048,u,f,{internalformat:m.RGBA32F,format:m.RGBA,type:m.FLOAT}),d.textureFilter(m.NEAREST),this.__samples.set(e,{name:e,texture:d,sampleRate:n,duration:i}),this.__program&&this.__program.code.search("sample_"+e)&&this.__program.requiredSamples.add(e),this.__programCue&&this.__programCue.code.search("sample_"+e)&&this.__programCue.requiredSamples.add(e),this.__emit("loadSample",{name:e,duration:i,sampleRate:n}),[2]}}))}))},e.prototype.deleteSample=function(e){this.__samples.has(e)&&(this.__samples.delete(e),this.__emit("deleteSample",{name:e}))},e.prototype.update=function(){var e,t=this.sampleRate,r=this.__bufferLength,n=this.__audio,a=n.currentTime;this.beatManager.update(a);var i="applying"===this.__cueStatus?Math.floor((this.__programSwapTime-a)*t):1/0;if((i=Math.min(i,r))<0){this.__setCueStatus("none");var o=this.__program;this.__program=this.__programCue,o&&o.program.dispose(!0),this.__programCue=null,i=r}var s=this.__bufferPool.next();this.__program&&this.__prepareBuffer(this.__program,s,0,i),i<r&&this.__programCue&&this.__prepareBuffer(this.__programCue,s,i,r-i);var u=n.createBufferSource();u.buffer=s,u.connect(this.__node);var f=n.currentTime-a;null===(e=this.__prevBufferSource)||void 0===e||e.stop(n.currentTime),u.start(n.currentTime,f),this.__prevBufferSource=u,this.__emit("update")},e.prototype.__prepareBuffer=function(e,t,r,n){var a=this,i=this.beatManager,o=i.time,s=i.beatSeconds,u=i.barSeconds,f=i.sixteenBarSeconds,_=i.beat,l=i.bar,p=i.sixteenBar,h=i.deltaTime,m=this.sampleRate,d=this.__glCat.gl;this.params.forEach((function(t){t.factor<=0?t.value=t.target:t.value=c.lerp(t.target,t.value,Math.exp(-t.factor*h)),e.program.uniform4f("param_"+t.name,t.target,t.value,t.factor,0)})),this.samples.forEach((function(t){e.program.uniformTexture("sample_"+t.name,t.texture),e.program.uniform4f("sample_"+t.name+"_meta",t.texture.width,t.texture.height,t.sampleRate,t.duration)})),e.program.attribute("off",this.__bufferOff,1),e.program.uniform1f("bpm",this.bpm),e.program.uniform1f("_deltaSample",1/m),e.program.uniform4f("timeLength",s,u,f,1e16),e.program.uniform4f("_timeHead",_,l,p,o),this.__glCat.useProgram(e.program,(function(){a.__glCat.bindTransformFeedback(a.__transformFeedback,(function(){d.enable(d.RASTERIZER_DISCARD),d.beginTransformFeedback(d.POINTS),d.drawArrays(d.POINTS,r,n),d.endTransformFeedback(),d.disable(d.RASTERIZER_DISCARD)}))})),d.flush();var b=t.getChannelData(0);this.__glCat.bindVertexBuffer(this.__bufferTransformFeedbacks[0],(function(){d.getBufferSubData(d.ARRAY_BUFFER,0,b,r,n)}));var g=t.getChannelData(1);this.__glCat.bindVertexBuffer(this.__bufferTransformFeedbacks[1],(function(){d.getBufferSubData(d.ARRAY_BUFFER,0,g,r,n)}))},e.prototype.__setCueStatus=function(e){this.__cueStatus=e,this.__emit("changeCueStatus",{cueStatus:e})},e.prototype.__processErrorMessage=function(e){var t,r=null!==(t=null==e?void 0:e.message)&&void 0!==t?t:e;return r?r.replace(/ERROR: (\d+):(\d+)/g,(function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var n=parseInt(t[1])-o.shaderchunkPreLines+1;return"ERROR: "+t[0]+":"+n})):null},e}();t.WavenerdDeck=l,_.applyMixins(l,[u.EventEmittable])},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BeatManager=void 0;var n=r(2),a=r(3),i=r(6),o=function(){function e(){this.__bpm=140,this.__time=0,this.__deltaTime=0,this.__beat=0,this.__bar=0,this.__sixteenBar=0}return e.CalcBeatSeconds=function(e){return 60/e},e.CalcBarSeconds=function(e){return 240/e},e.CalcSixteenBarSeconds=function(e){return 3840/e},Object.defineProperty(e.prototype,"bpm",{get:function(){return this.__bpm},set:function(e){var t=this.__bpm;this.__bpm=Math.max(0,e),this.__sixteenBar=this.__sixteenBar*t/this.__bpm,this.__emit("changeBPM",{bpm:this.__bpm})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beatSeconds",{get:function(){return e.CalcBeatSeconds(this.__bpm)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"barSeconds",{get:function(){return e.CalcBarSeconds(this.__bpm)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sixteenBarSeconds",{get:function(){return e.CalcSixteenBarSeconds(this.__bpm)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"time",{get:function(){return this.__time},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"deltaTime",{get:function(){return this.__deltaTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beat",{get:function(){return this.__beat},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bar",{get:function(){return this.__bar},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sixteenBar",{get:function(){return this.__sixteenBar},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this.__time=0,this.__sixteenBar=0},e.prototype.update=function(t){var r=e.CalcBeatSeconds(this.__bpm),n=e.CalcBarSeconds(this.__bpm),a=e.CalcSixteenBarSeconds(this.__bpm);this.__deltaTime=t-this.__time,this.__sixteenBar=i.mod(this.__sixteenBar+this.__deltaTime,a),this.__bar=i.mod(this.__sixteenBar,n),this.__beat=i.mod(this.__bar,r),this.__time=t;var o={time:t,deltaTime:this.__deltaTime,bpm:this.__bpm,beat:this.__beat,bar:this.__bar,sixteenBar:this.__sixteenBar};return this.__emit("update",o),o},e}();t.BeatManager=o,a.applyMixins(o,[n.EventEmittable])},function(e,t,r){"use strict";var n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o};Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmittable=void 0;var a=function(){function e(){}return e.prototype.on=function(e,t){this.__eventListeners=this.__eventListeners||new Map;var r=this.__eventListeners.get(e);return r||(r=[],this.__eventListeners.set(e,r)),r.push(t),t},e.prototype.off=function(e,t){this.__eventListeners=this.__eventListeners||new Map;var r=this.__eventListeners.get(e);r||(r=[],this.__eventListeners.set(e,r));var n=r.indexOf(t);-1!==n&&r.splice(n,1)},e.prototype.__emit=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var a=n(t,2),i=a[0],o=a[1];this.__eventListeners=this.__eventListeners||new Map,null===(e=this.__eventListeners.get(i))||void 0===e||e.forEach((function(e){return e(o)}))},e}();t.EventEmittable=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.applyMixins=void 0,t.applyMixins=function(e,t){t.forEach((function(t){Object.getOwnPropertyNames(t.prototype).forEach((function(r){Object.defineProperty(e.prototype,r,Object.getOwnPropertyDescriptor(t.prototype,r))}))}))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);Object.defineProperty(t,"WavenerdDeck",{enumerable:!0,get:function(){return n.WavenerdDeck}});var a=r(1);Object.defineProperty(t,"BeatManager",{enumerable:!0,get:function(){return a.BeatManager}});var i=r(0);t.default=i.WavenerdDeck},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shaderchunkPost=t.shaderchunkPreLines=t.shaderchunkPre=void 0,t.shaderchunkPre="#version 300 es\n\nprecision highp float;\n\n#define _PI 3.14159265359\n\nuniform float bpm;\nuniform vec4 timeLength;\nuniform float sampleRate;\nuniform float _deltaSample;\nuniform vec4 _timeHead;\n\nin float off;\n\nout float outL;\nout float outR;\n\nfloat paramFetch( vec4 param ) {\n  return mix( param.x, param.y, exp( -param.z * off * _deltaSample ) );\n}\n\nvec2 sampleNearest( sampler2D s, vec4 meta, float time ) {\n  if ( meta.w < time ) { return vec2( 0.0 ); }\n  float x = time / meta.x * meta.z;\n  vec2 uv = fract( vec2(\n    x,\n    floor( x ) / meta.y\n  ) ) + 0.5 / meta.xy;\n  return texture( s, uv ).xy;\n}\n\n// I have 0% confidence that the algorithm is perfect\nvec2 sampleSinc( sampler2D s, vec4 meta, float time ) {\n  if ( meta.w < time ) { return vec2( 0.0 ); }\n  vec2 sum = vec2( 0.0 );\n  float def = 0.5 - fract( time * meta.z );\n  for ( int i = -5; i <= 5; i ++ ) {\n    float x = floor( time * meta.z + float( i ) ) / meta.x;\n    float deft = def + float( i );\n    vec2 uv = fract( vec2(\n      x,\n      floor( x ) / meta.y\n    ) ) + 0.5 / meta.xy;\n    sum += texture( s, uv ).xy * min( sin( deft * _PI ) / deft / _PI, 1.0 );\n  }\n  return sum;\n}\n",t.shaderchunkPreLines=t.shaderchunkPre.split("\n").length,t.shaderchunkPost="void main() {\n  vec2 out2 = mainAudio( mod( _timeHead + off * _deltaSample, timeLength ) );\n  outL = out2.x;\n  outR = out2.y;\n}"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mod=void 0,t.mod=function(e,t){return e-Math.floor(e/t)*t}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Pool=void 0;var n=function(){function e(e){this.__index=0,this.array=e}return Object.defineProperty(e.prototype,"current",{get:function(){return this.array[this.__index]},enumerable:!1,configurable:!0}),e.prototype.next=function(){return this.__index=(this.__index+1)%this.array.length,this.current},e}();t.Pool=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lerp=void 0,t.lerp=function(e,t,r){return e+(t-e)*r}}])}));