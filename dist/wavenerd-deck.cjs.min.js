// (c) 2020-2022 0b5vr - https://github.com/0b5vr/wavenerd-deck/blob/release/LICENSE
var T=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var W=(s,e,t)=>e in s?T(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var I=(s,e)=>{for(var t in e)T(s,t,{get:e[t],enumerable:!0})},O=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of w(e))!N.call(s,a)&&a!==t&&T(s,a,{get:()=>e[a],enumerable:!(r=U(e,a))||r.enumerable});return s};var G=s=>O(T({},"__esModule",{value:!0}),s);var i=(s,e,t)=>(W(s,typeof e!="symbol"?e+"":e,t),t);var d=(s,e,t)=>new Promise((r,a)=>{var n=u=>{try{_(t.next(u))}catch(m){a(m)}},o=u=>{try{_(t.throw(u))}catch(m){a(m)}},_=u=>u.done?r(u.value):Promise.resolve(u.value).then(n,o);_((t=t.apply(s,e)).next())});var V={};I(V,{BeatManager:()=>c,WavenerdDeck:()=>b,default:()=>z});module.exports=G(V);var R=class{constructor(){i(this,"__eventListeners")}on(e,t){this.__eventListeners=this.__eventListeners||new Map;let r=this.__eventListeners.get(e);return r||(r=[],this.__eventListeners.set(e,r)),r.push(t),t}off(e,t){this.__eventListeners=this.__eventListeners||new Map;let r=this.__eventListeners.get(e);r||(r=[],this.__eventListeners.set(e,r));let a=r.indexOf(t);a!==-1&&r.splice(a,1)}__emit(...[e,t]){var r;this.__eventListeners=this.__eventListeners||new Map,(r=this.__eventListeners.get(e))==null||r.forEach(a=>a(t))}};function S(s,e){e.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(r=>{Object.defineProperty(s.prototype,r,Object.getOwnPropertyDescriptor(t.prototype,r))})})}function x(s,e){return s-Math.floor(s/e)*e}var c=class{constructor(){i(this,"__bpm",140);i(this,"__time",0);i(this,"__beat",0);i(this,"__bar",0);i(this,"__sixteenBar",0)}static CalcBeatSeconds(e){return 60/e}static CalcBarSeconds(e){return 240/e}static CalcSixteenBarSeconds(e){return 3840/e}get bpm(){return this.__bpm}set bpm(e){let t=this.__bpm;this.__bpm=Math.max(0,e),this.__sixteenBar=this.__sixteenBar*t/this.__bpm,this.__emit("changeBPM",{bpm:this.__bpm})}get beatSeconds(){return c.CalcBeatSeconds(this.__bpm)}get barSeconds(){return c.CalcBarSeconds(this.__bpm)}get sixteenBarSeconds(){return c.CalcSixteenBarSeconds(this.__bpm)}get time(){return this.__time}get beat(){return this.__beat}get bar(){return this.__bar}get sixteenBar(){return this.__sixteenBar}reset(){this.__time=0,this.__sixteenBar=0}update(e){let t=c.CalcBeatSeconds(this.__bpm),r=c.CalcBarSeconds(this.__bpm),a=c.CalcSixteenBarSeconds(this.__bpm),n=e-this.__time;this.__sixteenBar=x(this.__sixteenBar+n,a),this.__bar=x(this.__sixteenBar,r),this.__beat=x(this.__bar,t),this.__time=e;let o={time:e,bpm:this.__bpm,beat:this.__beat,bar:this.__bar,sixteenBar:this.__sixteenBar};return this.__emit("update",o),o}};S(c,[R]);var A=`/* eslint-disable */

const BLOCK_SIZE = 128;
const CHANNELS = 2;
const BUFFER_SIZE_PER_CHANNEL = 65536;

class BufferReaderProcessor extends AudioWorkletProcessor {
  constructor() {
    super();

    this.blocks = 0;
    this.buffer = new Float32Array( CHANNELS * BUFFER_SIZE_PER_CHANNEL );

    this.port.onmessage = ( { data } ) => {
      this.buffer.set( ...data );
    };
  }

  process( inputs, outputs, parameters ) {
    const buffer = this.buffer;
    if ( buffer == null ) { return true; }

    const head = ( BLOCK_SIZE * this.blocks ) % BUFFER_SIZE_PER_CHANNEL;

    outputs[ 0 ].forEach( ( ch, iCh ) => {
      const chHead = BUFFER_SIZE_PER_CHANNEL * iCh + head;
      ch.set( buffer.subarray( chHead, chHead + BLOCK_SIZE ) );
    } );

    this.blocks ++;

    this.port.postMessage( this.blocks );

    return true;
  }
}

registerProcessor( 'buffer-reader-processor', BufferReaderProcessor );
`;var Y=128,K=2,C=65536,Z=new Blob([A],{type:"text/javascript"}),X=URL.createObjectURL(Z),v=class extends AudioWorkletNode{constructor(t){super(t,"buffer-reader-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[K]});i(this,"__readBlocks");this.__readBlocks=0,this.port.onmessage=({data:r})=>{this.__readBlocks=r}}get readBlocks(){return this.__readBlocks}static addModule(t){return t.audioWorklet.addModule(X)}write(t,r,a,n){let o=C*t+Y*r%C+a;this.port.postMessage([n,o])}};var P=`#version 300 es

precision highp float;

#define _PI 3.14159265359

uniform float bpm;
uniform vec4 timeLength;
uniform float sampleRate;
uniform float _deltaSample;
uniform vec4 _timeHead;

in float off;

out float outL;
out float outR;

float paramFetch( vec4 param ) {
  return mix( param.x, param.y, exp( -param.z * off * _deltaSample ) );
}

vec2 sampleNearest( sampler2D s, vec4 meta, float time ) {
  if ( meta.w < time ) { return vec2( 0.0 ); }
  float x = time / meta.x * meta.z;
  vec2 uv = fract( vec2(
    x,
    floor( x ) / meta.y
  ) ) + 0.5 / meta.xy;
  return texture( s, uv ).xy;
}

// I have 0% confidence that the algorithm is perfect
vec2 sampleSinc( sampler2D s, vec4 meta, float time ) {
  if ( meta.w < time ) { return vec2( 0.0 ); }
  vec2 sum = vec2( 0.0 );
  float def = 0.5 - fract( time * meta.z );
  for ( int i = -5; i <= 5; i ++ ) {
    float x = floor( time * meta.z + float( i ) ) / meta.x;
    float deft = def + float( i );
    vec2 uv = fract( vec2(
      x,
      floor( x ) / meta.y
    ) ) + 0.5 / meta.xy;
    sum += texture( s, uv ).xy * min( sin( deft * _PI ) / deft / _PI, 1.0 );
  }
  return sum;
}
`,F=P.split(`
`).length,L=`void main() {
  vec2 out2 = mainAudio( mod( _timeHead + off * _deltaSample, timeLength ) );
  outL = out2.x;
  outR = out2.y;
}`;function k(s,e,t,r={}){var f,g;let{extParallel:a,tfVaryings:n,tfBufferMode:o}=r,_=null,u=null,m=null;try{if(_=s.createShader(s.VERTEX_SHADER),s.shaderSource(_,e),s.compileShader(_),!s.getShaderParameter(_,s.COMPILE_STATUS))throw new Error((f=s.getShaderInfoLog(_))!=null?f:void 0);if(u=s.createShader(s.FRAGMENT_SHADER),s.shaderSource(u,t),s.compileShader(u),!s.getShaderParameter(u,s.COMPILE_STATUS))throw new Error((g=s.getShaderInfoLog(u))!=null?g:void 0);return m=s.createProgram(),s.attachShader(m,_),s.attachShader(m,u),n&&s.transformFeedbackVaryings(m,n,o!=null?o:s.SEPARATE_ATTRIBS),s.linkProgram(m),new Promise((h,E)=>{let p=()=>{var B;if(!a||s.getProgramParameter(m,a.COMPLETION_STATUS_KHR)===!0){s.getProgramParameter(m,s.LINK_STATUS)?h(m):(s.deleteProgram(m),E(new Error((B=s.getProgramInfoLog(m))!=null?B:void 0)));return}setTimeout(p,10)};p()})}catch(h){return s.deleteProgram(m),Promise.reject(h)}finally{s.deleteShader(u),s.deleteShader(_)}}var j=128,y=class{constructor(e,t){i(this,"gl");i(this,"blocksPerRender");i(this,"__extParallel");i(this,"__offsetBuffer");i(this,"__tfBuffers");i(this,"__transformFeedback");i(this,"__program");i(this,"__programCue");i(this,"__textures");i(this,"__dstArrays");this.blocksPerRender=t,this.gl=e,this.__extParallel=e.getExtension("KHR_parallel_shader_compile"),this.__offsetBuffer=this.__createOffsetBuffer(),this.__tfBuffers=[this.__createTFBuffer(),this.__createTFBuffer()],this.__transformFeedback=this.__createTransformFeedback(this.__tfBuffers),this.__dstArrays=[new Float32Array(this.framesPerRender),new Float32Array(this.framesPerRender)],this.__program=null,this.__programCue=null,this.__textures=new Map}get framesPerRender(){return j*this.blocksPerRender}dispose(){let{gl:e}=this;e.deleteBuffer(this.__offsetBuffer),e.deleteBuffer(this.__tfBuffers[0]),e.deleteBuffer(this.__tfBuffers[1]),e.deleteTransformFeedback(this.__transformFeedback),e.deleteProgram(this.__program),e.deleteProgram(this.__programCue),this.__textures.forEach(t=>{e.deleteTexture(t)})}compile(e){return d(this,null,function*(){let{gl:t}=this,r=yield k(t,P+e+L,`#version 300 es
void main(){discard;}`,{extParallel:this.__extParallel,tfVaryings:["outL","outR"]}).catch(a=>{throw this.__programCue=null,t.deleteProgram(this.__programCue),a});r!=null&&(this.__programCue=r)})}applyCue(){let{gl:e}=this;if(this.__programCue==null)return;let t=this.__program;this.__program=this.__programCue,t!=null&&e.deleteProgram(t),this.__programCue=null}uploadTexture(e,t,r,a){let{gl:n}=this,o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.texImage2D(n.TEXTURE_2D,0,n.RGBA32F,t,r,0,n.RGBA,n.FLOAT,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.bindTexture(n.TEXTURE_2D,null),this.__textures.set(e,o)}deleteTexture(e){let{gl:t}=this,r=this.__textures.get(e);r!=null&&(t.deleteTexture(r),this.__textures.delete(e))}uniform1f(e,t){let{gl:r,__program:a}=this;if(a==null)return;let n=r.getUniformLocation(a,e);r.useProgram(a),r.uniform1f(n,t),r.useProgram(null)}uniform4f(e,...t){let{gl:r,__program:a}=this;if(a==null)return;let n=r.getUniformLocation(a,e);r.useProgram(a),r.uniform4f(n,...t),r.useProgram(null)}uniformTexture(e,t,r){let{gl:a,__program:n}=this;if(n==null)return;let o=this.__textures.get(t);if(o==null)return;let _=a.getUniformLocation(n,e);a.activeTexture(a.TEXTURE0+r),a.bindTexture(a.TEXTURE_2D,o),a.useProgram(n),a.uniform1i(_,r),a.useProgram(null)}render(e,t){return d(this,null,function*(){let{gl:r,__program:a}=this;if(a==null)return this.__dstArrays;let n=r.getAttribLocation(a,"off");return r.bindBuffer(r.ARRAY_BUFFER,this.__offsetBuffer),r.enableVertexAttribArray(n),r.vertexAttribPointer(n,1,r.FLOAT,!1,0,0),r.useProgram(a),r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,this.__transformFeedback),r.enable(r.RASTERIZER_DISCARD),r.beginTransformFeedback(r.POINTS),r.drawArrays(r.POINTS,e,t),r.endTransformFeedback(),r.disable(r.RASTERIZER_DISCARD),r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,null),r.useProgram(null),r.bindBuffer(r.ARRAY_BUFFER,this.__tfBuffers[0]),r.getBufferSubData(r.ARRAY_BUFFER,0,this.__dstArrays[0],e,t),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ARRAY_BUFFER,this.__tfBuffers[1]),r.getBufferSubData(r.ARRAY_BUFFER,0,this.__dstArrays[1],e,t),r.bindBuffer(r.ARRAY_BUFFER,null),this.__dstArrays})}__createOffsetBuffer(){let{gl:e,framesPerRender:t}=this,r=new Float32Array(t).map((n,o)=>o),a=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),a}__createTFBuffer(){let{gl:e,framesPerRender:t}=this,r=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,t*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_COPY),e.bindBuffer(e.ARRAY_BUFFER,null),r}__createTransformFeedback(e){let{gl:t}=this,r=t.createTransformFeedback();return t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,r),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,e[0]),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,1,e[1]),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null),r}};function M(s,e,t){return s+(e-s)*t}var D=128,b=class{constructor({gl:e,audio:t,hostDeck:r,latencyBlocks:a,blocksPerRender:n,bpm:o}){i(this,"hostDeck");i(this,"latencyBlocks");i(this,"__cueStatus","none");i(this,"__blocksPerRender");i(this,"__lastUpdatedTime");i(this,"__renderer");i(this,"__lastError");i(this,"__audio");i(this,"__node");i(this,"__bufferReaderNode");i(this,"__bufferWriteBlocks");i(this,"__beatManager");i(this,"__program");i(this,"__programCue");i(this,"__programSwapTime");i(this,"__params",new Map);i(this,"__samples",new Map);this.latencyBlocks=a!=null?a:16,this.__blocksPerRender=n!=null?n:16,r&&(this.hostDeck=r),this.__beatManager=new c,this.__beatManager.bpm=o!=null?o:140,this.__beatManager.on("changeBPM",({bpm:_})=>{this.__emit("changeBPM",{bpm:_})}),this.__lastUpdatedTime=0,this.__renderer=new y(e,this.blocksPerRender),this.__program=null,this.__programCue=null,this.__programSwapTime=0,this.__audio=t,this.__node=t.createGain(),v.addModule(t).then(()=>{this.__bufferReaderNode=new v(t),this.__bufferReaderNode.connect(this.__node)}),this.__bufferWriteBlocks=0}get cueStatus(){return this.__cueStatus}get blocksPerRender(){return this.__blocksPerRender}get framesPerRender(){return D*this.__blocksPerRender}get bpm(){return this.beatManager.bpm}set bpm(e){this.beatManager.bpm=e}get lastError(){return this.__lastError}get audio(){return this.__audio}get node(){return this.__node}get sampleRate(){return this.__audio.sampleRate}get beatManager(){var t;let e=(t=this.hostDeck)==null?void 0:t.beatManager;return e||this.__beatManager}get params(){return this.__params}get samples(){return this.hostDeck?this.hostDeck.samples:this.__samples}dispose(){var e;this.__setCueStatus("none"),this.__renderer.dispose(),(e=this.__bufferReaderNode)==null||e.disconnect()}compile(e){return d(this,null,function*(){this.__setCueStatus("compiling"),yield this.__renderer.compile(e).catch(r=>{let a=this.__processErrorMessage(r);throw this.__programCue=null,this.__setCueStatus("none"),this.__emit("error",{error:a}),this.__lastError=a,new Error(a!=null?a:void 0)});let t=new Set;for(let r of this.samples.keys())e.search("sample_"+r)!==-1&&t.add(r);this.__programCue={code:e,requiredSamples:t},this.__setCueStatus("ready"),this.__emit("error",{error:null}),this.__lastError=null})}applyCue(){this.__cueStatus==="ready"&&(this.__setCueStatus("applying"),this.__programSwapTime=this.beatManager.time-this.beatManager.bar+this.beatManager.barSeconds)}setParam(e,t,r=50){let a=this.params.get(e);a?(a.target=t,a.factor=r):this.params.set(e,{name:e,target:t,value:t,factor:r}),this.__emit("setParam",{name:e,value:t,factor:r})}loadSample(e,t){return d(this,null,function*(){let r=yield this.__audio.decodeAudioData(t),{sampleRate:a,duration:n}=r,o=r.length,_=2048,m=Math.ceil(o/2048),f=new Float32Array(_*m*4),g=r.numberOfChannels,h=r.getChannelData(0),E=r.getChannelData(g===1?0:1);for(let p=0;p<o;p++)f[p*4+0]=h[p],f[p*4+1]=E[p];this.__renderer.uploadTexture(e,_,m,f),this.samples.set(e,{name:e,width:_,height:m,sampleRate:a,duration:n}),this.__program&&this.__program.code.search("sample_"+e)&&this.__program.requiredSamples.add(e),this.__programCue&&this.__programCue.code.search("sample_"+e)&&this.__programCue.requiredSamples.add(e),this.__emit("loadSample",{name:e,duration:n,sampleRate:a})})}deleteSample(e){this.samples.has(e)&&(this.samples.delete(e),this.__renderer.deleteTexture(e),this.__emit("deleteSample",{name:e}))}update(){return d(this,null,function*(){let e=this.__bufferReaderNode;if(e==null)return;let{readBlocks:t}=e,{sampleRate:r,blocksPerRender:a,framesPerRender:n}=this,o=this.__bufferWriteBlocks-t;if(o>this.latencyBlocks)return;o<0&&(this.__bufferWriteBlocks=(Math.floor(t/a)+1)*a);let _=D*this.__bufferWriteBlocks/r;this.beatManager.update(_);let u=this.__cueStatus==="applying"?Math.floor((this.__programSwapTime-_)*r):1/0;u=Math.min(u,n),u<0&&(this.__setCueStatus("none"),this.__renderer.applyCue(),this.__program=this.__programCue,this.__programCue=null,u=n),this.__program&&(yield this.__prepareBuffer(0,u)),u<n&&this.__programCue!=null&&(this.__setCueStatus("none"),this.__renderer.applyCue(),this.__program=this.__programCue,this.__programCue=null,yield this.__prepareBuffer(u,n-u)),this.__bufferWriteBlocks+=this.blocksPerRender,this.__emit("update")})}__prepareBuffer(e,t){return d(this,null,function*(){let r=this.__bufferReaderNode;if(r==null)return;let{time:a,beatSeconds:n,barSeconds:o,sixteenBarSeconds:_,beat:u,bar:m,sixteenBar:f}=this.beatManager,{sampleRate:g}=this,h=a-this.__lastUpdatedTime;this.__lastUpdatedTime=a,this.params.forEach(l=>{l.factor<=0?l.value=l.target:l.value=M(l.target,l.value,Math.exp(-l.factor*h)),this.__renderer.uniform4f("param_"+l.name,l.target,l.value,l.factor,0)});let E=0;this.samples.forEach(l=>{this.__renderer.uniformTexture("sample_"+l.name,l.name,E),E++,this.__renderer.uniform4f("sample_"+l.name+"_meta",l.width,l.height,l.sampleRate,l.duration)}),this.__renderer.uniform1f("bpm",this.bpm),this.__renderer.uniform1f("_deltaSample",1/g),this.__renderer.uniform4f("timeLength",n,o,_,1e16),this.__renderer.uniform4f("_timeHead",u,m,f,a);let[p,B]=yield this.__renderer.render(e,t);r.write(0,this.__bufferWriteBlocks,e,p.subarray(e,e+t)),r.write(1,this.__bufferWriteBlocks,e,B.subarray(e,e+t))})}__setCueStatus(e){this.__cueStatus=e,this.__emit("changeCueStatus",{cueStatus:e})}__processErrorMessage(e){var r;let t=(r=e==null?void 0:e.message)!=null?r:e;return t?t.replace(/ERROR: (\d+):(\d+)/g,(a,...n)=>{let o=parseInt(n[1])-F+1;return`ERROR: ${n[0]}:${o}`}):null}};S(b,[R]);var z=b;
//# sourceMappingURL=wavenerd-deck.cjs.min.js.map
