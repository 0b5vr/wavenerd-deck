// (c) 2020-2022 0b5vr - https://github.com/0b5vr/wavenerd-deck/blob/release/LICENSE
var W=Object.defineProperty;var I=(i,e,r)=>e in i?W(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r;var n=(i,e,r)=>(I(i,typeof e!="symbol"?e+"":e,r),r);var p=(i,e,r)=>new Promise((t,a)=>{var s=u=>{try{_(r.next(u))}catch(m){a(m)}},o=u=>{try{_(r.throw(u))}catch(m){a(m)}},_=u=>u.done?t(u.value):Promise.resolve(u.value).then(s,o);_((r=r.apply(i,e)).next())});var E=class{constructor(){n(this,"__eventListeners")}on(e,r){this.__eventListeners=this.__eventListeners||new Map;let t=this.__eventListeners.get(e);return t||(t=[],this.__eventListeners.set(e,t)),t.push(r),r}off(e,r){this.__eventListeners=this.__eventListeners||new Map;let t=this.__eventListeners.get(e);t||(t=[],this.__eventListeners.set(e,t));let a=t.indexOf(r);a!==-1&&t.splice(a,1)}__emit(...[e,r]){var t;this.__eventListeners=this.__eventListeners||new Map,(t=this.__eventListeners.get(e))==null||t.forEach(a=>a(r))}};function y(i,e){e.forEach(r=>{Object.getOwnPropertyNames(r.prototype).forEach(t=>{Object.defineProperty(i.prototype,t,Object.getOwnPropertyDescriptor(r.prototype,t))})})}function B(i,e){return i-Math.floor(i/e)*e}var l=class{constructor(){n(this,"__bpm",140);n(this,"__time",0);n(this,"__beat",0);n(this,"__bar",0);n(this,"__sixteenBar",0)}static CalcBeatSeconds(e){return 60/e}static CalcBarSeconds(e){return 240/e}static CalcSixteenBarSeconds(e){return 3840/e}get bpm(){return this.__bpm}set bpm(e){let r=this.__bpm;this.__bpm=Math.max(0,e),this.__sixteenBar=this.__sixteenBar*r/this.__bpm,this.__emit("changeBPM",{bpm:this.__bpm})}get beatSeconds(){return l.CalcBeatSeconds(this.__bpm)}get barSeconds(){return l.CalcBarSeconds(this.__bpm)}get sixteenBarSeconds(){return l.CalcSixteenBarSeconds(this.__bpm)}get time(){return this.__time}get beat(){return this.__beat}get bar(){return this.__bar}get sixteenBar(){return this.__sixteenBar}reset(){this.__time=0,this.__sixteenBar=0}update(e){let r=l.CalcBeatSeconds(this.__bpm),t=l.CalcBarSeconds(this.__bpm),a=l.CalcSixteenBarSeconds(this.__bpm),s=e-this.__time;this.__sixteenBar=B(this.__sixteenBar+s,a),this.__bar=B(this.__sixteenBar,t),this.__beat=B(this.__bar,r),this.__time=e;let o={time:e,bpm:this.__bpm,beat:this.__beat,bar:this.__bar,sixteenBar:this.__sixteenBar};return this.__emit("update",o),o}};y(l,[E]);var A=`/* eslint-disable */

const BLOCK_SIZE = 128;
const CHANNELS = 2;
const BUFFER_SIZE_PER_CHANNEL = 65536;

class BufferReaderProcessor extends AudioWorkletProcessor {
  constructor() {
    super();

    this.blocks = 0;
    this.buffer = new Float32Array( CHANNELS * BUFFER_SIZE_PER_CHANNEL );

    this.port.onmessage = ( { data } ) => {
      this.buffer.set( ...data );
    };
  }

  process( inputs, outputs, parameters ) {
    const buffer = this.buffer;
    if ( buffer == null ) { return true; }

    const head = ( BLOCK_SIZE * this.blocks ) % BUFFER_SIZE_PER_CHANNEL;

    outputs[ 0 ].forEach( ( ch, iCh ) => {
      const chHead = BUFFER_SIZE_PER_CHANNEL * iCh + head;
      ch.set( buffer.subarray( chHead, chHead + BLOCK_SIZE ) );
    } );

    this.blocks ++;

    this.port.postMessage( this.blocks );

    return true;
  }
}

registerProcessor( 'buffer-reader-processor', BufferReaderProcessor );
`;var O=128,G=2,C=65536,H=new Blob([A],{type:"text/javascript"}),X=URL.createObjectURL(H),R=class extends AudioWorkletNode{constructor(r){super(r,"buffer-reader-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[G]});n(this,"__readBlocks");this.__readBlocks=0,this.port.onmessage=({data:t})=>{this.__readBlocks=t}}get readBlocks(){return this.__readBlocks}static addModule(r){return r.audioWorklet.addModule(X)}write(r,t,a,s){let o=C*r+O*t%C+a;this.port.postMessage([s,o])}};var P=`#version 300 es

precision highp float;

#define _PI 3.14159265359

uniform float bpm;
uniform vec4 timeLength;
uniform float sampleRate;
uniform float _deltaSample;
uniform vec4 _timeHead;

in float off;

out float outL;
out float outR;

float paramFetch( vec4 param ) {
  return mix( param.x, param.y, exp( -param.z * off * _deltaSample ) );
}

float wavetableNearest( sampler2D w, vec4 meta, vec2 position ) {
  vec2 uv0 = fract( vec2(
    position.x,
    ( floor( fract( position.y ) * ( meta.y - 1.0 ) ) + 0.5 ) / meta.y
  ) );
  vec2 uv1 = uv0 + vec2( 0.0, 1.0 / meta.y );
  return mix(
    texture( w, uv0 ).x,
    texture( w, uv1 ).x,
    fract( position.y * ( meta.y - 1.0 ) )
  );
}

float wavetableSinc( sampler2D w, vec4 meta, vec2 position ) {
  float sum = 0.0;
  float def = -fract( position.x * meta.x );
  for ( int i = -5; i <= 5; i ++ ) {
    float x = floor( position.x * meta.x + float( i ) ) / meta.x;
    float deft = def + float( i );
    vec2 uv0 = fract( vec2(
      x,
      ( floor( fract( position.y ) * ( meta.y - 1.0 ) ) + 0.5 ) / meta.y
    ) );
    vec2 uv1 = uv0 + vec2( 0.0, 1.0 / meta.y );
    sum += mix(
      texture( w, uv0 ).x,
      texture( w, uv1 ).x,
      fract( position.y * ( meta.y - 1.0 ) )
    ) * min( sin( deft * _PI ) / deft / _PI, 1.0 );
  }
  return sum;
}

vec2 sampleNearest( sampler2D s, vec4 meta, float time ) {
  if ( meta.w < time ) { return vec2( 0.0 ); }
  float x = time / meta.x * meta.z;
  vec2 uv = fract( vec2(
    x,
    floor( x ) / meta.y
  ) ) + 0.5 / meta.xy;
  return texture( s, uv ).xy;
}

vec2 sampleSinc( sampler2D s, vec4 meta, float time ) {
  if ( meta.w < time ) { return vec2( 0.0 ); }
  vec2 sum = vec2( 0.0 );
  float def = -fract( time * meta.z );
  for ( int i = -5; i <= 5; i ++ ) {
    float x = floor( time * meta.z + float( i ) ) / meta.x;
    float deft = def + float( i );
    vec2 uv = fract( vec2(
      x,
      floor( x ) / meta.y
    ) ) + 0.5 / meta.xy;
    sum += texture( s, uv ).xy * min( sin( deft * _PI ) / deft / _PI, 1.0 );
  }
  return sum;
}
`,F=P.split(`
`).length,L=`void main() {
  vec2 out2 = mainAudio( mod( _timeHead + off * _deltaSample, timeLength ) );
  outL = out2.x;
  outR = out2.y;
}`;function k(i,e,r,t={}){var h,v;let{extParallel:a,tfVaryings:s,tfBufferMode:o}=t,_=null,u=null,m=null;try{if(_=i.createShader(i.VERTEX_SHADER),i.shaderSource(_,e),i.compileShader(_),!i.getShaderParameter(_,i.COMPILE_STATUS))throw new Error((h=i.getShaderInfoLog(_))!=null?h:void 0);if(u=i.createShader(i.FRAGMENT_SHADER),i.shaderSource(u,r),i.compileShader(u),!i.getShaderParameter(u,i.COMPILE_STATUS))throw new Error((v=i.getShaderInfoLog(u))!=null?v:void 0);return m=i.createProgram(),i.attachShader(m,_),i.attachShader(m,u),s&&i.transformFeedbackVaryings(m,s,o!=null?o:i.SEPARATE_ATTRIBS),i.linkProgram(m),new Promise((g,x)=>{let f=()=>{var d;if(!a||i.getProgramParameter(m,a.COMPLETION_STATUS_KHR)===!0){i.getProgramParameter(m,i.LINK_STATUS)?g(m):(i.deleteProgram(m),x(new Error((d=i.getProgramInfoLog(m))!=null?d:void 0)));return}setTimeout(f,10)};f()})}catch(g){return i.deleteProgram(m),Promise.reject(g)}finally{i.deleteShader(u),i.deleteShader(_)}}var Y=128,S=class{constructor(e,r){n(this,"gl");n(this,"blocksPerRender");n(this,"__extParallel");n(this,"__offsetBuffer");n(this,"__tfBuffers");n(this,"__transformFeedback");n(this,"__program");n(this,"__programCue");n(this,"__textures");n(this,"__dstArrays");this.blocksPerRender=r,this.gl=e,this.__extParallel=e.getExtension("KHR_parallel_shader_compile"),this.__offsetBuffer=this.__createOffsetBuffer(),this.__tfBuffers=[this.__createTFBuffer(),this.__createTFBuffer()],this.__transformFeedback=this.__createTransformFeedback(this.__tfBuffers),this.__dstArrays=[new Float32Array(this.framesPerRender),new Float32Array(this.framesPerRender)],this.__program=null,this.__programCue=null,this.__textures=new Map}get framesPerRender(){return Y*this.blocksPerRender}dispose(){let{gl:e}=this;e.deleteBuffer(this.__offsetBuffer),e.deleteBuffer(this.__tfBuffers[0]),e.deleteBuffer(this.__tfBuffers[1]),e.deleteTransformFeedback(this.__transformFeedback),e.deleteProgram(this.__program),e.deleteProgram(this.__programCue),this.__textures.forEach(r=>{e.deleteTexture(r)})}compile(e){return p(this,null,function*(){let{gl:r}=this,t=yield k(r,P+e+L,`#version 300 es
void main(){discard;}`,{extParallel:this.__extParallel,tfVaryings:["outL","outR"]}).catch(a=>{throw this.__programCue=null,r.deleteProgram(this.__programCue),a});t!=null&&(this.__programCue=t)})}applyCue(){let{gl:e}=this;if(this.__programCue==null)return;let r=this.__program;this.__program=this.__programCue,r!=null&&e.deleteProgram(r),this.__programCue=null}uploadTexture(e,r,t,a){let{gl:s}=this,o=s.createTexture();s.bindTexture(s.TEXTURE_2D,o),s.texImage2D(s.TEXTURE_2D,0,s.RGBA32F,r,t,0,s.RGBA,s.FLOAT,a),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.bindTexture(s.TEXTURE_2D,null),this.__textures.set(e,o)}uploadImageSource(e,r){let{gl:t}=this,a=t.createTexture();t.bindTexture(t.TEXTURE_2D,a),t.texImage2D(t.TEXTURE_2D,0,t.RGBA8,t.RGBA,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.bindTexture(t.TEXTURE_2D,null),this.__textures.set(e,a)}deleteTexture(e){let{gl:r}=this,t=this.__textures.get(e);t!=null&&(r.deleteTexture(t),this.__textures.delete(e))}uniform1f(e,r){let{gl:t,__program:a}=this;if(a==null)return;let s=t.getUniformLocation(a,e);t.useProgram(a),t.uniform1f(s,r),t.useProgram(null)}uniform4f(e,...r){let{gl:t,__program:a}=this;if(a==null)return;let s=t.getUniformLocation(a,e);t.useProgram(a),t.uniform4f(s,...r),t.useProgram(null)}uniformTexture(e,r){let{gl:t,__program:a}=this;if(a==null)return;let s=this.__textures.get(e);if(s==null)return;let o=t.getUniformLocation(a,e);t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,s),t.useProgram(a),t.uniform1i(o,r),t.useProgram(null)}render(e,r){return p(this,null,function*(){let{gl:t,__program:a}=this;if(a==null)return this.__dstArrays;let s=t.getAttribLocation(a,"off");return t.bindBuffer(t.ARRAY_BUFFER,this.__offsetBuffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,1,t.FLOAT,!1,0,0),t.useProgram(a),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.__transformFeedback),t.enable(t.RASTERIZER_DISCARD),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,e,r),t.endTransformFeedback(),t.disable(t.RASTERIZER_DISCARD),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,this.__tfBuffers[0]),t.getBufferSubData(t.ARRAY_BUFFER,0,this.__dstArrays[0],e,r),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,this.__tfBuffers[1]),t.getBufferSubData(t.ARRAY_BUFFER,0,this.__dstArrays[1],e,r),t.bindBuffer(t.ARRAY_BUFFER,null),this.__dstArrays})}__createOffsetBuffer(){let{gl:e,framesPerRender:r}=this,t=new Float32Array(r).map((s,o)=>o),a=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),a}__createTFBuffer(){let{gl:e,framesPerRender:r}=this,t=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,r*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_COPY),e.bindBuffer(e.ARRAY_BUFFER,null),t}__createTransformFeedback(e){let{gl:r}=this,t=r.createTransformFeedback();return r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,t),r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,e[0]),r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,1,e[1]),r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,null),t}};function w(i,e,r){return i+(e-i)*r}var D=128,T=class{constructor({gl:e,audio:r,hostDeck:t,latencyBlocks:a,blocksPerRender:s,bpm:o}){n(this,"hostDeck");n(this,"latencyBlocks");n(this,"__cueStatus","none");n(this,"__blocksPerRender");n(this,"__lastUpdatedTime");n(this,"__renderer");n(this,"__lastError");n(this,"__audio");n(this,"__node");n(this,"__bufferReaderNode");n(this,"__bufferWriteBlocks");n(this,"__beatManager");n(this,"__program");n(this,"__programCue");n(this,"__programSwapTime");n(this,"__params",new Map);n(this,"__textures",new Map);this.latencyBlocks=a!=null?a:16,this.__blocksPerRender=s!=null?s:16,t&&(this.hostDeck=t),this.__beatManager=new l,this.__beatManager.bpm=o!=null?o:140,this.__beatManager.on("changeBPM",({bpm:_})=>{this.__emit("changeBPM",{bpm:_})}),this.__lastUpdatedTime=0,this.__renderer=new S(e,this.blocksPerRender),this.__program=null,this.__programCue=null,this.__programSwapTime=0,this.__audio=r,this.__node=r.createGain(),R.addModule(r).then(()=>{this.__bufferReaderNode=new R(r),this.__bufferReaderNode.connect(this.__node)}),this.__bufferWriteBlocks=0}get cueStatus(){return this.__cueStatus}get blocksPerRender(){return this.__blocksPerRender}get framesPerRender(){return D*this.__blocksPerRender}get bpm(){return this.beatManager.bpm}set bpm(e){this.beatManager.bpm=e}get lastError(){return this.__lastError}get audio(){return this.__audio}get node(){return this.__node}get sampleRate(){return this.__audio.sampleRate}get beatManager(){var r;let e=(r=this.hostDeck)==null?void 0:r.beatManager;return e||this.__beatManager}get params(){return this.__params}get textures(){return this.hostDeck?this.hostDeck.textures:this.__textures}dispose(){var e;this.__setCueStatus("none"),this.__renderer.dispose(),(e=this.__bufferReaderNode)==null||e.disconnect()}compile(e){return p(this,null,function*(){this.__setCueStatus("compiling"),yield this.__renderer.compile(e).catch(t=>{let a=this.__processErrorMessage(t);throw this.__programCue=null,this.__setCueStatus("none"),this.__emit("error",{error:a}),this.__lastError=a,new Error(a!=null?a:void 0)});let r=new Set;for(let t of this.textures.values()){let a=`${t.type}_${t.name}`;e.search(a)!==-1&&r.add(a)}this.__programCue={code:e,requiredTextures:r},this.__setCueStatus("ready"),this.__emit("error",{error:null}),this.__lastError=null})}applyCue(){this.__cueStatus==="ready"&&(this.__setCueStatus("applying"),this.__programSwapTime=this.beatManager.time-this.beatManager.bar+this.beatManager.barSeconds)}setParam(e,r,t=50){let a=this.params.get(e);a?(a.target=r,a.factor=t):this.params.set(e,{name:e,target:r,value:r,factor:t}),this.__emit("setParam",{name:e,value:r,factor:t})}loadWavetable(e,r){return p(this,null,function*(){let t=r.length/2048,a=new Float32Array(r.length*4);for(let o=0;o<r.length;o++)a[o*4+0]=r[o];let s=`wavetable_${e}`;this.__renderer.uploadTexture(s,2048,t,a),this.textures.set(s,{type:"wavetable",name:e,width:2048,height:t}),this.__program&&this.__program.code.search(s)&&this.__program.requiredTextures.add(e),this.__programCue&&this.__programCue.code.search(s)&&this.__programCue.requiredTextures.add(e),this.__emit("loadWavetable",{name:e})})}deleteWavetable(e){let r=`wavetable_${e}`;this.textures.has(r)&&(this.textures.delete(r),this.__renderer.deleteTexture(r),this.__emit("deleteWavetable",{name:e}))}loadImage(e,r){return p(this,null,function*(){let t=`image_${e}`;this.__renderer.uploadImageSource(t,r),this.textures.set(t,{type:"image",name:e,width:r.width,height:r.height}),this.__program&&this.__program.code.search(t)&&this.__program.requiredTextures.add(e),this.__programCue&&this.__programCue.code.search(t)&&this.__programCue.requiredTextures.add(e),this.__emit("loadImage",{name:e})})}deleteImage(e){let r=`image_${e}`;this.textures.has(r)&&(this.textures.delete(r),this.__renderer.deleteTexture(r),this.__emit("deleteImage",{name:e}))}loadSample(e,r){return p(this,null,function*(){let t=yield this.__audio.decodeAudioData(r),{sampleRate:a,duration:s}=t,o=t.length,_=2048,m=Math.ceil(o/2048),h=new Float32Array(_*m*4),v=t.numberOfChannels,g=t.getChannelData(0),x=t.getChannelData(v===1?0:1);for(let d=0;d<o;d++)h[d*4+0]=g[d],h[d*4+1]=x[d];let f=`sample_${e}`;this.__renderer.uploadTexture(f,_,m,h),this.textures.set(f,{type:"sample",name:e,width:_,height:m,sampleRate:a,duration:s}),this.__program&&this.__program.code.search(f)&&this.__program.requiredTextures.add(e),this.__programCue&&this.__programCue.code.search(f)&&this.__programCue.requiredTextures.add(e),this.__emit("loadSample",{name:e,duration:s,sampleRate:a})})}deleteSample(e){let r=`sample_${e}`;this.textures.has(r)&&(this.textures.delete(r),this.__renderer.deleteTexture(r),this.__emit("deleteSample",{name:e}))}update(){return p(this,null,function*(){let e=this.__bufferReaderNode;if(e==null)return;let{readBlocks:r}=e,{sampleRate:t,blocksPerRender:a,framesPerRender:s}=this,o=this.__bufferWriteBlocks-r;if(o>this.latencyBlocks)return;o<0&&(this.__bufferWriteBlocks=(Math.floor(r/a)+1)*a);let _=D*this.__bufferWriteBlocks/t;this.beatManager.update(_);let u=this.__cueStatus==="applying"?Math.floor((this.__programSwapTime-_)*t):1/0;u=Math.min(u,s),u<0&&(this.__setCueStatus("none"),this.__renderer.applyCue(),this.__program=this.__programCue,this.__programCue=null,u=s),this.__program&&(yield this.__prepareBuffer(0,u)),u<s&&this.__programCue!=null&&(this.__setCueStatus("none"),this.__renderer.applyCue(),this.__program=this.__programCue,this.__programCue=null,yield this.__prepareBuffer(u,s-u)),this.__bufferWriteBlocks+=this.blocksPerRender,this.__emit("update")})}__prepareBuffer(e,r){return p(this,null,function*(){let t=this.__bufferReaderNode;if(t==null)return;let{time:a,beatSeconds:s,barSeconds:o,sixteenBarSeconds:_,beat:u,bar:m,sixteenBar:h}=this.beatManager,{sampleRate:v}=this,g=a-this.__lastUpdatedTime;this.__lastUpdatedTime=a,this.params.forEach(c=>{c.factor<=0?c.value=c.target:c.value=w(c.target,c.value,Math.exp(-c.factor*g)),this.__renderer.uniform4f("param_"+c.name,c.target,c.value,c.factor,0)});let x=0,{requiredTextures:f}=this.__program;for(let c of f){let b=this.textures.get(c);if(b!=null){this.__renderer.uniformTexture(c,x),x++;let N=b.type==="sample"?[b.width,b.height,b.sampleRate,b.duration]:[b.width,b.height,0,0];this.__renderer.uniform4f(c+"_meta",...N)}}this.__renderer.uniform1f("bpm",this.bpm),this.__renderer.uniform1f("_deltaSample",1/v),this.__renderer.uniform4f("timeLength",s,o,_,1e16),this.__renderer.uniform4f("_timeHead",u,m,h,a);let[d,M]=yield this.__renderer.render(e,r);t.write(0,this.__bufferWriteBlocks,e,d.subarray(e,e+r)),t.write(1,this.__bufferWriteBlocks,e,M.subarray(e,e+r))})}__setCueStatus(e){this.__cueStatus=e,this.__emit("changeCueStatus",{cueStatus:e})}__processErrorMessage(e){var t;let r=(t=e==null?void 0:e.message)!=null?t:e;return r?r.replace(/ERROR: (\d+):(\d+)/g,(a,...s)=>{let o=parseInt(s[1])-F+1;return`ERROR: ${s[0]}:${o}`}):null}};y(T,[E]);var be=T;export{l as BeatManager,T as WavenerdDeck,be as default};
//# sourceMappingURL=wavenerd-deck.esm.min.js.map
